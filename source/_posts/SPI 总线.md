---
title: SPI 总线
categories:
  - 外设
  - 嵌入式
date: 2020-05-03 08:10:33
tags:
  - 外设
  - 嵌入式
---

# 概述

SPI是串行外设接口(Serial Peripheral Interface)的缩写。是 Motorola 公司推出的一种同步串行接口技术，是一种高速的，全双工，同步的通信总线。

## 优缺点

### 特点

1. 高速、同步、全双工、非差分、总线式
1. 主从机通信模式

### 优点
1. 支持全双工通信
1. 通信简单
1. 数据传输速率块

### 缺点

1. 没有指定的流控制，没有应答机制确认是否接收到数据，所以跟IIC总线协议比较在数据
1. 可靠性上有一定的缺陷。

# 协议详解

它以主从方式工作，这种模式通常有一个主设备和一个或多个从设备，需要至少4根线，事实上3根也可以(单向传输时)。也是所有基于SPI的设备共有的，它们是SDI(数据输入)、SDO(数据输出)、SCLK(时钟)、CS(片选)。

1. SDO/MOSI – 主设备数据输出，从设备数据输入;
1. SDI/MISO – 主设备数据输入，从设备数据输出;
1. SCLK – 时钟信号，由主设备产生;
1. CS/SS – 从设备使能信号，由主设备控制。当有多个从设备的时候，因为每个从设备上都有一个片选引脚接入到主设备机中，当我们的主设备和某个从设备通信时将需要将从设备对应的片选引脚电平拉低或者是拉高。

![mark](http://depot.wanqiang.wang/blog/20200503/Q13S5At43CUc.png?imageslim)

SPI通信有4种不同的模式，不同的从设备可能在出厂是就是配置为某种模式，这是不能改变的；但我们的通信双方必须是工作在同一模式下，所以我们可以对我们的主设备的SPI模式进行配置，通过CPOL（时钟极性）和CPHA（时钟相位）来控制我们主设备的通信模式，具体如下：

1. Mode0：CPOL=0，CPHA=0
1. Mode1：CPOL=0，CPHA=1
1. Mode2：CPOL=1，CPHA=0
1. Mode3：CPOL=1，CPHA=1

时钟极性CPOL是用来配置SCLK的电平出于哪种状态时是空闲态或者有效态，时钟相位CPHA是用来配置数据采样是在第几个边沿：

1. CPOL=0，表示当SCLK=0时处于空闲态，所以有效状态就是SCLK处于高电平时
1. CPOL=1，表示当SCLK=1时处于空闲态，所以有效状态就是SCLK处于低电平时
1. CPHA=0，表示数据采样是在第1个边沿，数据发送在第2个边沿
1. CPHA=1，表示数据采样是在第2个边沿，数据发送在第1个边沿

例如：

CPOL=0，CPHA=0：此时空闲态时，SCLK处于低电平，数据采样是在第1个边沿，也就是
SCLK由低电平到高电平的跳变，所以数据采样是在上升沿，数据发送是在下降沿。

CPOL=0，CPHA=1：此时空闲态时，SCLK处于低电平，数据发送是在第1个边沿，也就是
SCLK由低电平到高电平的跳变，所以数据采样是在下降沿，数据发送是在上升沿。

CPOL=1，CPHA=0：此时空闲态时，SCLK处于高电平，数据采集是在第1个边沿，也就是
SCLK由高电平到低电平的跳变，所以数据采集是在下降沿，数据发送是在上升沿。

CPOL=1，CPHA=1：此时空闲态时，SCLK处于高电平，数据发送是在第1个边沿，也就是
SCLK由高电平到低电平的跳变，所以数据采集是在上升沿，数据发送是在下降沿。

![mark](http://depot.wanqiang.wang/blog/20200503/DrlkwQgyKQ6W.png?imageslim)

![mark](http://depot.wanqiang.wang/blog/20200503/aJgCAIwhwlHC.png?imageslim)

需要注意的是：我们的主设备能够控制时钟，因为我们的SPI通信并不像UART或者IIC通信
那样有专门的通信周期，有专门的通信起始信号，有专门的通信结束信号；所以我们的
SPI协议能够通过控制时钟信号线，当没有数据交流的时候我们的时钟线要么是
保持高电平要么是保持低电平。

# 协议对比

## spi 与 iic

1.  iic总线不是全双工，2根线SCL SDA。spi总线实现全双工，4根线SCK CS MOSI MISO

1.  iic总线是多主机总线，通过SDA上的地址信息来锁定从设备。spi总线只有一个主设备，主设备通过CS片选来确定从设备

1.  iic总线传输速度在100kbps-4Mbps。spi总线传输速度更快，可以达到30MHZ以上。

1.  iic总线空闲状态下SDA SCL都是高电平。spi总线空闲状态MOSI MISO也都是 SCK是有CPOL决定的

1.  iic总线scl高电平时sda下降沿标志传输开始，上升沿标志传输结束。spi总线cs拉低标志传输开始，cs拉高标志传输结束

1.  iic总线是SCL高电平采样。spi总线因为是全双工，因此是沿采样，具体要根据CPHA决定。一般情况下master device是SCK的上升沿发送，下降沿采集

1.  iic总线和spi总线数据传输都是MSB在前，LSB在后（串口是LSB在前）

1.  iic总线和spi总线时钟都是由主设备产生，并且只在数据传输时发出时钟

1.  iic总线读写时序比较固定统一，设备驱动编写方便。spi总线不同从设备读写时序差别比较大，因此必须根据具体的设备datasheet来实现读写，相对复杂一些。

## SPI、IIC、UART和CAN 使用场景对比

SPI 和I2C这两种通信方式都是短距离的，芯片和芯片之间或者其他元器件如传感器和芯片之间的通信。SPI和IIC是板上通信,IIC有时也会做板间通信,不过距离甚短,不过超过一米,例如一些触摸屏,手机液晶屏那些薄膜排线很多用IIC,I2C能用于替代标准的并行总线，能连接的各种集成电路和功能模块。I2C是多主控总线，所以任何一个设备都能像主控器一样工作，并控制总线。总线上每一个设备都有一个独一无二的地址，根据设备它们自己的能力，它们可以作为发射器或接收器工作。多路微控制器能在同一个I2C总线上共存这两种线属于低速传输。

而UART是应用于两个设备之间的通信，如用单片机做好的设备和计算机的通信。这样的通信可以做长距离的。UART速度比上面两者者快,最高达100K左右,用与计算机与设备或者计算机和计算之间通信,但有效范围不会很长,约10米左右,UART优点是支持面广,程序设计结构很简单,随着USB的发展,UART也逐渐走向下坡。

1. CAN 通讯距离最大是10 公里（设速率为5Kbps）,或最大通信速率为1Mbps(设通信距离为40 米)。
1. CAN 总线上的节点数可达110 个。通信介质可在双绞线，同轴电缆，光纤中选择。
1. CAN 采用非破坏性的总线仲裁技术，当多个节点同时发送数据时，优先级低的节点会主动退出发送，高优先级的节点可继续发送，节省总线仲裁时间。
1. CAN 是多主方式工作，网上的任一节点均可在任意时刻主动地向网络上其他节点发送信息。
1. CAN 采用报文识别符识别网络上的节点，从而把节点分成不同的优先级，高优先级的节点享有传送报文的优先权。报文是短帧结构，短的传送时间使其受干扰概率低，CAN 有很好的效验机制，这些都保证了CAN 通信的可靠性。

